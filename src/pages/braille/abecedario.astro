---
import ClientRouter from "astro/components/ClientRouter.astro";
import brailleMap from "../../utils/brailleMap";
import "../../style/base.css";

import CustomLetter from "../../components/braille/custom-letter.astro";

import LogoCbtis from "../../components/logos/logo-cbtis.astro";
import LogoCaed from "../../components/logos/logo-caed.astro";
import IconSound from "../../components/icons/icon-sound.astro";

import IconLeftArrow from "../../style/icon-left-arrow.astro";

const letters = Array.from({ length: 26 }, (_, i) =>
    String.fromCharCode(65 + i),
);

import { generateSpeech } from "../../utils/textToSpeech";
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Abecedario en braille</title>
        <ClientRouter />
    </head>
    <body class="bg-gradient-generic flex flex-col items-center justify-center">
        <nav class="flex justify-around items-center w-full h-1/2 py-5">
            <a href="../" class="h-full flex justify-center">
                <IconLeftArrow size="50%" color="#0B3441" />
            </a>
            <a
                href="https://cbtis212.online/"
                class="h-full flex justify-center"
            >
                <LogoCbtis size="50%" color="#0B3441" />
            </a>
            <div class="flex justify-center items-center w-full h-full">
                <h2 class="text-4xl c-title-text text-center text-[#0B3441]">
                    Seccion de braille
                </h2>
            </div>
            <a href="" class="h-full flex justify-center">
                <LogoCaed size="50%" color="#0B3441" />
            </a>
            <a href="../braille" class="h-full flex justify-center rotate-180">
                <IconLeftArrow size="50%" color="#0B3441" />
            </a>
        </nav>

        <main
            class="bg-[#EDFEFE80] h-5/6 w-6/7 max-h-[70%] rounded-[12.5px] grid grid-cols-6 grid-auto-rows gap-2 p-2"
        >
            {
                letters.map((letter: string) => {
                    const minusLetter = letter.toLowerCase();
                    return (
                        <article class="flex flex-col justify-between items-center p-5">
                            <CustomLetter letter={minusLetter} />
                            <button
                                class="flex justify-center items-center p-3 cursor-pointer"
                                data-letter={minusLetter}
                            >
                                <IconSound size="100px" color="#0B3441" />
                            </button>
                        </article>
                    );
                })
            }
        </main>
    </body>
</html>

<script>
    // Este script se ejecuta en el navegador
    import { generateSpeech } from "../../utils/textToSpeech";
    import brailleMap from "../../utils/brailleMap";

    // Obtener todos los botones de sonido
    const soundButtons = document.querySelectorAll("button[data-letter]");

    // Añadir evento click a cada botón
    soundButtons.forEach((button) => {
        button.addEventListener("click", async () => {
            const letter = button.getAttribute("data-letter");
            if (!letter) return;

            try {
                button.classList.add("loading");

                let text = `La letra ${letter} en Braille es: `;
                let firstPoint = true;

                for (let col = 0; col < 2; col++) {
                    for (let row = 0; row < 3; row++) {
                        const index = col * 3 + row;
                        if (brailleMap[letter][index] === 1) {
                            if (!firstPoint) {
                                text += ", ";
                            } else {
                                firstPoint = false;
                            }
                            text += `Un punto en la columna ${col + 1} y en la fila ${row + 1}`;
                        }
                    }
                }

                // Generar y reproducir el audio

                const audioUrl = await generateSpeech(text, {
                    speed: 0.75,
                    similarity: 0.75,
                    voiceId: "zrHiDhphv9ZnVXBqCLjz",
                });
                if (audioUrl) {
                    const audio = new Audio(audioUrl);
                    await audio.play();
                }
            } catch (error) {
                console.error(
                    `Error al reproducir el sonido para ${letter}:`,
                    error,
                );
            } finally {
                // Restaurar apariencia del botón
                button.classList.remove("loading");
            }
        });
    });
</script>
